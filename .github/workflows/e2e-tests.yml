name: E2E Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'cmd/**'
      - 'internal/**'
      - 'tests/e2e/**'
      - 'Dockerfile'
      - 'Dockerfile.cli'
      - 'docker-compose.e2e.yml'
      - 'scripts/run-e2e-tests.sh'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'cmd/**'
      - 'internal/**'
      - 'tests/e2e/**'
      - 'Dockerfile'
      - 'Dockerfile.cli'
      - 'docker-compose.e2e.yml'
      - 'scripts/run-e2e-tests.sh'
      - '.github/workflows/e2e-tests.yml'

env:
  GO_VERSION: '1.24'

jobs:
  e2e-tests:
    name: E2E Tests (Docker)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set build variables
        id: vars
        run: |
          echo "VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo 'dev')" >> $GITHUB_OUTPUT
          echo "BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
          echo "GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')" >> $GITHUB_OUTPUT

      - name: Build backend Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          load: true
          tags: portfolios-backend:e2e-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build CLI Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.cli
          build-args: |
            VERSION=${{ steps.vars.outputs.VERSION }}
            BUILD_DATE=${{ steps.vars.outputs.BUILD_DATE }}
            GIT_COMMIT=${{ steps.vars.outputs.GIT_COMMIT }}
          load: true
          tags: portfolios-cli:e2e-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update docker-compose to use built images
        run: |
          # Use the locally built images instead of building again
          sed -i 's|build:|# build:|g' docker-compose.e2e.yml
          sed -i 's|context:|# context:|g' docker-compose.e2e.yml
          sed -i 's|dockerfile:|# dockerfile:|g' docker-compose.e2e.yml
          sed -i 's|args:|# args:|g' docker-compose.e2e.yml
          sed -i 's|VERSION:|# VERSION:|g' docker-compose.e2e.yml
          sed -i 's|BUILD_DATE:|# BUILD_DATE:|g' docker-compose.e2e.yml
          sed -i 's|GIT_COMMIT:|# GIT_COMMIT:|g' docker-compose.e2e.yml
          sed -i '/backend-e2e:/a\    image: portfolios-backend:e2e-test' docker-compose.e2e.yml
          sed -i '/cli-e2e:/a\    image: portfolios-cli:e2e-test' docker-compose.e2e.yml

      - name: Start E2E test environment
        run: |
          docker compose -f docker-compose.e2e.yml up -d
          echo "Waiting for services to be healthy..."

          # Wait for backend to be healthy (max 120 seconds)
          for i in {1..24}; do
            if docker compose -f docker-compose.e2e.yml ps backend-e2e | grep -q "healthy"; then
              echo "Backend is healthy!"
              break
            fi
            if [ $i -eq 24 ]; then
              echo "Backend did not become healthy in time"
              docker compose -f docker-compose.e2e.yml logs backend-e2e
              exit 1
            fi
            echo "Waiting for backend... ($i/24)"
            sleep 5
          done

          # Give it a few more seconds to fully initialize
          sleep 5

      - name: Run E2E tests
        run: |
          docker compose -f docker-compose.e2e.yml exec -T cli-e2e \
            sh -c "cd /tests && go test -v -timeout 15m ./..."
        env:
          TEST_TIMEOUT: 15m

      - name: Show backend logs on failure
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker compose -f docker-compose.e2e.yml logs backend-e2e
          echo ""
          echo "=== PostgreSQL Logs ==="
          docker compose -f docker-compose.e2e.yml logs postgres-e2e
          echo ""
          echo "=== CLI Container Logs ==="
          docker compose -f docker-compose.e2e.yml logs cli-e2e

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.e2e.yml down -v --remove-orphans

  # Summary job that depends on e2e-tests
  e2e-complete:
    name: E2E Tests Complete
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: always()
    steps:
      - name: Check E2E test results
        run: |
          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "E2E tests failed or were cancelled"
            exit 1
          fi
          echo "All E2E tests passed successfully!"
